<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
          integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
          integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
          crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
<header class="header">
  <div class="container">
    <h1 class="main-tittle">
      ЭКСКУРСИИ В ТУРЦИИ <span class="yellow_text"> АНТАЛИЯ - KEMER </span>Ginza Travel
    </h1>
  </div>

  <nav class="nav">
    <ul class="nav__list">
      <li class="nav__list-item">
        <a href="" class="nav__link">
          ГЛАВНАЯ
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          О нас
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Из Кемера
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Аренда Яхты
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Аренда Авто
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Трансферы
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Vip экскурсии
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Шоппинг
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Аренда виллы
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Медицина
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Отзывы
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Контакты
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          FAQ
        </a>
      </li>
      <li class="nav__list-item">
        <a href="" class="nav__link">
          Блог
        </a>
      </li>
    </ul>
  </nav>

</header>

<section class="region">
  <h2 class="region__tittle">ВЫБЕРИТЕ ВАШ РЕГИОН</h2>
  <div id="carouselExample" class="carousel slide region__carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'img/region_1.jpg' %}" class="d-block w-100 carouserl__img" alt="...">
      </div>
      <div class="carousel-item">
        <img src="{% static 'img/region_2.webp' %}" class="d-block w-100 carouserl__img" alt="...">
      </div>
      <div class="carousel-item">
        <img src="{% static 'img/region_3.jpg' %}" class="d-block w-100 carouserl__img" alt="...">
      </div>
      <div class="carousel-item">
        <img src="{% static 'img/region_4.jpg' %}" class="d-block w-100 carouserl__img" alt="...">
      </div>
      <div class="carousel-item">
        <img src="{% static 'img/region_5.webp' %}" class="d-block w-100 carouserl__img" alt="...">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
</section>

<section class="orders">
  <div class="container">
    <div class="cards">
      {% for card in cards %}
      <div class="card my_card">
        <a href="#" class="card__link">
          <img src="{{ card.image.url }}" class="card-img-top card__img" alt="">
          <div class="card-body">
            <p class="card-text">{{ card.description }}</p>
            <p class="card-text card__price">{{ card.price }} $</p>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<footer class="footer">
  <div class="container">
    <div class="flex">
      <div class="footer__nav">
        <h3 class="footer__title">ВАШ РЕГИОН</h3>
        <ul class="footer__list">
          <li class="footer__item">
            <a href="" class="footer__link">
              Кемер
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Анталия
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Белек
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Сиде
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Алания
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Мармарис
            </a>
          </li>
        </ul>
      </div>
      <div class="footer__nav">
        <h3 class="footer__title">НАШИ УСЛУГИ</h3>
        <ul class="footer__list">
          <li class="footer__item">
            <a href="" class="footer__link">
              Экскурсии
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Аренда яхты
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Аренда авто
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Индивидуальные Экскурсии
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Шоппинг
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Аренда вилл в Бодруме
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Медицина в Турции
            </a>
          </li>
        </ul>
      </div>
      <div class="footer__nav">
        <h3 class="footer__title">ПОДДЕРЖКА</h3>
        <ul class="footer__list">
          <li class="footer__item">
            <a href="" class="footer__link">
              О нас
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Контакты
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Отзывы наших клиентов
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Часто задаваемые вопросы
            </a>
          </li>
          <li class="footer__item">
            <a href="" class="footer__link">
              Политика конфиденциальности
            </a>
          </li>
        </ul>
      </div>
      <div class="footer__nav">
        <h3 class="footer__title">ФОРМА ЗАЯВКИ</h3>
        <form action="" class="">
          <div class="footer__form flex">
            <div>
              <input type="text" class="form-control form__input" placeholder="Телефон (с кодом страны)">
              <input type="text" class="form-control form__input" placeholder="Имя">
              <input type="date" class="form-control form__input">
              <input type="email" class="form-control form__input" placeholder="Эл. почта">
              <input type="text" class="form-control form__input" placeholder="Название отеля / Номер комнаты">
              <input type="text" class="form-control form__input" placeholder="Экскурсия">
              <input type="text" class="form-control form__input" placeholder="Кол-во взрослых">
              <input type="text" class="form-control form__input" placeholder="Дети 0-6 лет">
              <input type="text" class="form-control form__input" placeholder="Дети 7-11 лет">
            </div>
            <div>
              <textarea class="form-control form__textarea" rows="3" placeholder="Ваше сообщение"></textarea>
            </div>
          </div>
          <button class="btn btn-warning form__button" type="submit">Отправить заявку</button>
        </form>
      </div>
    </div>
  </div>

  <button id="open-chat-btn" class="open-chat-btn">Открыть чат</button>

  <div id="chat-box" class="chat-box hidden">
    <div class="chat-header">
      <span>Чат</span>
      <button id="close-chat-btn" class="close-chat-btn">✖</button>
    </div>
    <div class="chat-messages" id="chat-messages">

    </div>
    <form class="chat-input" id="chat-form">
      <input type="text" id="message-input" placeholder="Введите сообщение...">
      <button type="submit">Отправить</button>
    </form>
  </div>

</footer>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const openChatBtn = document.getElementById('open-chat-btn');
    const closeChatBtn = document.getElementById('close-chat-btn');
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');

    // Проверка существования элементов
    if (!openChatBtn || !closeChatBtn || !chatBox || !chatForm || !chatMessages || !messageInput) {
        console.error('Один или несколько элементов чата отсутствуют на странице.');
        return;
    }

    // Открытие чата
    openChatBtn.addEventListener('click', () => {
        chatBox.classList.remove('hidden');
        openChatBtn.classList.add('hidden');
        loadMessages();  // Загрузка сообщений при открытии чата
    });

    // Закрытие чата
    closeChatBtn.addEventListener('click', () => {
        chatBox.classList.add('hidden');
        openChatBtn.classList.remove('hidden');
    });

    // Загрузка сообщений из API
    function loadMessages() {
        fetch('/shop/api/messages/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка загрузки: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                chatMessages.innerHTML = '';
                data.forEach(msg => {
                  const username = msg.username || 'Аноним';  // Замена undefined на 'Аноним', если имя отсутствует
                  const text = msg.text || 'Сообщение отсутствует';
                  const timestamp = msg.timestamp || '';

                  chatMessages.innerHTML += `<p><strong>${msg.username}:  </strong> ${msg.text}</p>`;
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;  // Прокрутка вниз
            })
            .catch(error => {
                console.error('Ошибка при загрузке сообщений:', error);
            });
    }

    // Отправка сообщения
    chatForm.onsubmit = function(event) {
        event.preventDefault();
        const content = messageInput.value.trim();

        if (content === '') {
            return;  // Не отправлять пустое сообщение
        }

        fetch('/shop/api/messages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // Получение CSRF-токена
            },
            body: JSON.stringify({
                username: 'User',  // Замените на актуальное имя пользователя
                text: content
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Ошибка отправки: ${response.statusText}`);
            }
            return response.json();
        })
        .then(() => {
            messageInput.value = '';  // Очищаем поле ввода
            loadMessages();  // Обновляем список сообщений
        })
        .catch(error => {
            console.error('Ошибка при отправке сообщения:', error);
        });
    };

    // Функция для получения CSRF-токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Автоматическое обновление чата каждые 5 секунд
    setInterval(loadMessages, 5000);
  });
</script>


</body>

</html>
